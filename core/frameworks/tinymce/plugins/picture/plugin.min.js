( function() {
  tinymce.PluginManager.add('picture', function(editor, url) {
    // Add a button that opens a window
    editor.addButton('pictureManager', {
      icon: 'image',
      title: 'Insérer/modifier une Image',
      onclick: function() {
        // Open window
        var img = editor.selection.getNode();
        img = (img && $(img).attr('src')) ? $(img) : false;

        var values = {
          alt: img ? $(img).attr('alt') : null,
          src: img ? $(img).attr('src') : '',
          width: null,
          height:  null,
          float: null,
          'margin-right': null,
          'margin-left': null,
          'margin-top': null,
          'margin-bottom': null,
        }
        var css = img ? $(img).attr('style') : null;
        if (css){
          css = css.split(';');
          for(var i in css){
            var v = css[i].split(':');
            if (v[1]) values[v[0].replace(' ','')] = v[1].replace(' ','');
          }
        }
        var rd = Acui.createId();
        var id = 'insert_image_'+rd;
        var id_path = 'path_image_'+rd;
        var id_alt = 'alt_image_'+rd;
        var mright = mleft = mtop = mbottom = float = alt = width = height = null;
        editor.windowManager.open({
          title: (img ? 'Modifier':'Insérer')+' une image',
          id: id,
          body: [
            { type: 'container',
            label  : 'Image',
            layout: '',
            style: 'height: 35px',
            items: [
              {type: 'textbox', name: 'file', id: id_path, style:'width:72%; float:left; height:30px', value: values.src.replace('../data/','')},
              {type: 'button', name: 'filemanager', icon: 'image', subtype: 'primary', style:'width:20%; height:30px; float:left',
                onclick: function() {
                   $('#mce-modal-block, #'+id).hide();
                    Acui.loadDirectory('pictures/');
                    Acui('Nav').ready(function(){
                      Acui('Nav').setEvents('click', {
                        'li[data-item=Pictures]': function(){
                          var path = $(this).attr('data-path');
                          $('#'+id_path).val(path);
                          Acui('Nav').close();
                          $('#mce-modal-block, #'+id).show();
                        }
                      });
                      Acui('Nav').preventClose = function(){
                         $('#mce-modal-block, #'+id).show();
                         return true;
                      }
                    });
                }},
            ]}, 
            {type: 'textbox', name: 'alt', label: 'Légende', onPostRender: function( ){alt = this; alt.value(values.alt)}},
            {type: 'textbox', name: 'width', label: 'Largeur', onPostRender: function( ){width = this; width.value(values.width)}},
            {type: 'textbox', name: 'height', label: 'Hauteur', onPostRender: function( ){height = this; height.value(values.height)}},
            {type: 'listbox', name: 'float', label: 'Flottement', name: 'flaot', values: [{text: 'Aucun', value:'none'}, {text: 'Droit', value:'right'}, {text: 'Gauche', value:'left'}], onPostRender: function( ){float = this;; float.value(values.float)}},
            { type: 'container',
              label  : 'Marges',
              layout: 'flow',
              style: 'text-align:center;margin-top: 1.5em;',
              items: [
                {type: 'textbox', name:'mtop', style:'width:30px; margin: auto; display:block', placeholder:'Haut', onPostRender: function(){ mtop = this; mtop.value(values['margin-top']) }},
                {type: 'textbox', name: 'mleft', style:'width:30px; display:inline-block; float: left', placeholder:'Gauche', onPostRender: function(){ mleft = this; mleft.value(values['margin-left']) }},
                {type: 'textbox', name: 'mright', style:'width:30px; display:inline-block; float: right;', placeholder:'Droite', onPostRender: function(){ mright = this; mright.value(values['margin-right']) }},
                {type: 'textbox', name: 'mbottom', style:'width:30px; margin: auto; display:block; clear: both', placeholder:'Bas', onPostRender: function(){ mbottom = this; mbottom.value(values['margin-bottom']) }},
              ]
            },
          ],
          onsubmit: function(e) {
            e.preventDefault();
            if ($('#'+id_path).val()=='') return Acui.notice('Aucune image choisie', 'error');
            if (alt.value()=='') return Acui.notice('Une légende est requise', 'error');
            var style="";
            if ( width.value()!=='' ) style += 'width: '+width.value()+';';
            if ( height.value()!=='' ) style += 'height: '+height.value()+';';
            if ( float.value()!=='none' ) style += 'float: '+float.value()+';';
            if ( mtop.value()!=='' ) style += 'margin-top: '+mtop.value()+';';
            if ( mleft.value()!=='' ) style += 'margin-left: '+mleft.value()+';';
            if ( mright.value()!=='' ) style += 'margin-right: '+mright.value()+';';
            if ( mbottom.value()!=='' ) style += 'margin-bottom: '+mbottom.value()+';';
            if (style!=='') style = ' style="'+style+'"';
            console.log(style);
            // Insert content when the window form is submitted
            editor.insertContent('<img src="../data/'+$('#'+id_path).val()+'" alt="'+alt.value()+'"'+style+'>');
            editor.windowManager.close();
          }
        });
      }
    });

  });
} )();
